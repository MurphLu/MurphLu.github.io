### OCçš„æœ¬è´¨

- æˆ‘ä»¬å¹³æ—¶ç¼–å†™çš„ Objective-C çš„ä»£ç ï¼Œåº•å±‚å®ç°å…¶å®éƒ½æ˜¯ C\C++ ä»£ç 
- Objective-C çš„é¢å‘å¯¹è±¡éƒ½æ˜¯åŸºäº C\C++ çš„æ•°æ®ç»“æ„å®ç°çš„
- Objective-C çš„å¯¹è±¡ã€ç±»éƒ½æ˜¯åŸºäº C\C++ çš„ç»“æ„ä½“å®ç°çš„

### OC è½¬ C\C++

OC è½¬ä¸º C++ ä»£ç 
`lang -rewrite-objc main.m -o main.cpp`

OC è½¬ä¸ºiPhone arm64 æ¶æ„ C++ ä»£ç 
`xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main.iphone64.cpp`

NSObject in Objective-C

```Objective-C
// NSObject çš„å®šä¹‰
@interface NSObject {
    Class isa;
}
```

main.cpp
```C++
// NSObject Implementation in cpp file
struct NSObject_IMPL {
    CLass isa;
};

// Class ä¸ºæŒ‡å‘ç»“æ„ä½“çš„æŒ‡é’ˆ
typedef struct objc_class *Class;
```

### ç»“æ„ä½“å†…å­˜åˆ†é…åŸåˆ™

- æ•°æ®æˆå‘˜å¯¹å…¶è§„åˆ™ï¼šç»“æ„ä½“ä¸­çš„æ•°æ®æˆå‘˜ï¼Œç¬¬ä¸€ä¸ªæ•°æ®æˆå‘˜æ”¾åœ¨offsetä¸º0çš„åœ°æ–¹ï¼Œä¹‹åæ¯ä¸ªæ•°æ®çš„èµ·å§‹ä½ç½®éƒ½è¦ä»è¯¥æˆå‘˜å¤§å°æˆ–è€…å…¶æœ€å¤§å­æˆå‘˜å¤§å°çš„æ•´æ•°å€å¼€å§‹å­˜å‚¨
- ç»“æ„ä½“å¤§å°ï¼Œå¿…é¡»ä¸ºå…¶å†…éƒ¨æœ€å¤§æˆå‘˜çš„æ•´æ•°å€ï¼Œä¸è¶³çš„è¦è¡¥é½
- åˆå§‹åŒ–ä¹‹åå®é™…å ç”¨å†…å­˜ï¼Œè¿˜è¦éµå¾ªç³»ç»Ÿå†…å­˜å¯¹å…¶åŸåˆ™ï¼Œç°åœ¨ä¸€èˆ¬ä¸º16å­—èŠ‚å¯¹å…¶

åœ¨å®šä¹‰ç»“æ„ä½“çš„æ—¶å€™ï¼Œå¦‚æœä¸¤ä¸ªç»“æ„ä½“æœ‰ç›¸åŒç±»å‹çš„æˆå‘˜ï¼Œå¹¶ä¸”æˆå‘˜é¡ºåºä¸åŒï¼Œé‚£ä¹ˆæœ€ç»ˆç»“æ„ä½“æ‰€å ç”¨çš„å†…å­˜æ˜¯æœ‰å¯èƒ½ä¸åŒçš„

ä»£ç ï¼š
```Objective-C
struct Struct1 {
    char a;     //1å­—èŠ‚ -- å æ®0å­—èŠ‚
    double b;   //8å­—èŠ‚ -- å æ®8-15å­—èŠ‚
    int c;      //4å­—èŠ‚ -- å æ®16-19å­—èŠ‚
    short d;    //2å­—èŠ‚ -- å æ®20-22å­—èŠ‚
} MyStruct1;    //å…±22å­—èŠ‚ï¼Œä½†22ä¸æ˜¯8çš„å€æ•°ï¼Œåˆ™+2ï¼Œå› ä¸º24æ˜¯8çš„å€æ•°

struct Struct2 {
    double b;   //8å­—èŠ‚ -- å æ®0-7å­—èŠ‚
    int c;      //4å­—èŠ‚ -- å æ®8-11å­—èŠ‚
    char a;     //1å­—èŠ‚ -- å æ®12å­—èŠ‚
    short d;    //2å­—èŠ‚ -- å æ®14-15å­—èŠ‚
} MyStruct2;    //å…±16å­—èŠ‚ï¼Œ16æ˜¯8çš„å€æ•°æ‰€ä»¥æ€»å¤§å°è¿˜æ˜¯16å­—èŠ‚


int main(int argc, const char * argv[]) {
    @autoreleasepool {
        NSLog(@"Struct1 sizeï¼š%lu",sizeof(MyStruct1)); // 24
        NSLog(@"Struct2 sizeï¼š%lu",sizeof(MyStruct2)); // 16
    }
    return 0;
}
```

### OC ä¸­ç±»çš„å†…å­˜åˆ†é…

ç”±äº OC ä¸­çš„ç±»åŒæ ·æ˜¯åŸºäº C\C++ ä¸­ç»“æ„ä½“æ¥å®ç°çš„ï¼Œæ‰€ä»¥ OC ä¸­ç±»çš„å†…å­˜åˆ†é…åŸåˆ™åŒç»“æ„ä½“æ˜¯ä¸€æ ·çš„

> OC ä¸­çš„æˆå‘˜å˜é‡ä¸å±æ€§çš„åŒºåˆ«
>> OC ä¸­çš„æˆå‘˜å˜é‡åœ¨ç”Ÿæˆç»“æ„ä½“çš„æ—¶å€™é¡ºåºä¸å®šä¹‰çš„é¡ºåºç›¸åŒï¼Œä½†æ˜¯å±æ€§åœ¨ç¼–è¯‘ç”Ÿæˆç»“æ„ä½“çš„æ—¶å€™ä¼šæœ‰ä¸€ä¸ªé‡æ’ï¼Œä¿è¯ç±»åœ¨éµå¾ªå†…å­˜åˆ†é…åŸåˆ™åå ç”¨å†…å­˜æœ€å°ï¼Œæ‰€ä»¥æˆå‘˜å˜é‡çš„é¡ºåºæœ‰å¯èƒ½ä¼šå½±å“ OC ç±»æœ€ç»ˆå†…å­˜å ç”¨å¤§å°ï¼Œè€Œå±æ€§çš„å®šä¹‰é¡ºåºä¸ä¼šã€‚

ä¸Š ğŸŒ° 

```Objective-C
@interface Cls1 : NSObject
@property (nonatomic, assign) double _b;
@property (nonatomic, assign) int _c;
@property (nonatomic, assign) char _a;
@property (nonatomic, assign) short _d;

@end

@implementation Cls1
@end

@interface Cls2 : NSObject
@property (nonatomic, assign) char _a;
@property (nonatomic, assign) double _b;
@property (nonatomic, assign) int _c;
@property (nonatomic, assign) short _d;
@end

@implementation Cls2
@end

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        NSLog(@"Cls1 sizeï¼š%lu, allocSize: %lu", class_getInstanceSize([Cls1 class]), malloc_size((__bridge const void *)([[Cls1 alloc] init])));
        NSLog(@"Cls2 sizeï¼š%lu, allocSize: %lu", class_getInstanceSize([Cls2 class]), malloc_size((__bridge const void *)([[Cls2 alloc] init])));
    }
    return 0;
}

// output
// Cls1 sizeï¼š24, allocSize: 32
// Cls2 sizeï¼š24, allocSize: 32

//ä»ä¸Šé¢ä¾‹å­ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶ä¸¤ä¸ªç±»å®šä¹‰çš„å±æ€§é¡ºåºåŒä¹‹å‰çš„ä¸¤ä¸ª struct ç›¸åŒï¼Œä½†æ˜¯ä¸¤ä¸ªç±»æœ€ç»ˆå ç”¨çš„å†…å­˜åŠç³»ç»Ÿæœ€ç»ˆåˆ†é…çš„å†…å­˜æ˜¯ç›¸åŒçš„
```


æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç”Ÿæˆ C++ ä¹‹åçš„ä»£ç 

```C++
struct Cls1_IMPL {
	struct NSObject_IMPL NSObject_IVARS;
	char __a;
	short __d;
	int __c;
	double __b;
};

struct Cls2_IMPL {
	struct NSObject_IMPL NSObject_IVARS;
	char __a;
	short __d;
	int __c;
	double __b;
};

// å¯ä»¥çœ‹åˆ°è½¬æˆ C++ ä»£ç ä¹‹åï¼Œç»“æ„çš„æˆå‘˜é¡ºåºå˜æˆäº†ä¸€æ ·çš„ï¼Œè¿™å°±è¯æ˜äº† OC ç±»åœ¨è½¬ä¸ºç»“æ„ä½“çš„è¿‡ç¨‹ä¸­ä¼šå¯¹å±æ€§è¿›è¡Œé‡æ’ï¼Œä¿è¯åœ¨æ»¡è¶³å†…å­˜åˆ†é…è§„åˆ™çš„å‰æä¸‹ä¿è¯å†…å­˜å ç”¨æœ€ä¼˜
```

*ä½†æ˜¯å¦‚æœç»™ç±»æ·»åŠ æˆå‘˜å˜é‡ä¼šæ€ä¹ˆæ ·å‘¢*
æˆ‘ä»¬è¿˜æ˜¯ç”¨ä»£ç æ¥è¯æ˜

```Objective-C
@interface Cls1 : NSObject
{
    char c;
    double d;
    int a;
    int b;

}
@property (nonatomic, assign) double _b;
@property (nonatomic, assign) int _c;
@property (nonatomic, assign) char _a;
@property (nonatomic, assign) short _d;
@property (nonatomic, assign) int _c1;

@end

@implementation Cls1
@end

@interface Cls2 : NSObject
{
    double d;
    int a;
    int b;
    char c;
}
@property (nonatomic, assign) char _a;
@property (nonatomic, assign) double _b;
@property (nonatomic, assign) int _c;
@property (nonatomic, assign) short _d;
@property (nonatomic, assign) int _c1;
@end

@implementation Cls2
@end

int main(int argc, const char * argv[]) {
    @autoreleasepool {  
        NSLog(@"Cls1 sizeï¼š%lu, allocSize: %lu", class_getInstanceSize([Cls1 class]), malloc_size((__bridge const void *)([[Cls1 alloc] init])));
        NSLog(@"Cls2 sizeï¼š%lu, allocSize: %lu", class_getInstanceSize([Cls2 class]), malloc_size((__bridge const void *)([[Cls2 alloc] init])));
    }
    return 0;
}
// output
// Cls1 sizeï¼š56, allocSize: 64
// Cls2 sizeï¼š48, allocSize: 48
```

æˆ‘ä»¬ç»§ç»­æ¥çœ‹ä¸€ä¸‹ç”Ÿæˆçš„ C++ ä»£ç 

``` C++
struct Cls1_IMPL {
	struct NSObject_IMPL NSObject_IVARS;  // 0-7
	char c;                               // 8
	double d;                             // 16-23
	int a;                                // 24-27
	int b;                                // 28-31
	char __a;                             // 32
	short __d;                            // 34-35
	int __c;                              // 36-39
	int __c1;                             // 40-43
	double __b;                           // 48-55
};
// æœ€ç»ˆå ç”¨ 56 å­—èŠ‚ï¼Œå®é™…å†…å­˜åˆ†é… 16å¯¹å…¶ï¼Œåˆ†é… 64

struct Cls2_IMPL {
	struct NSObject_IMPL NSObject_IVARS; // 0-7
	double d;                            // 8-15
	int a;                               // 16-19
	int b;                               // 20-23
	char c;                              // 24
	char __a;                            // 25
	short __d;                           // 26-27
	int __c;                             // 28-32
	int __c1;                            // 36-39
	double __b;                          // 40-47
};
// æœ€ç»ˆå ç”¨ 48 å­—èŠ‚ï¼Œå®é™…å†…å­˜åˆ†é… 16å¯¹å…¶ï¼Œåˆ†é… 48

// å¯ä»¥çœ‹åˆ°ï¼Œè½¬ä¸º C++ ä»£ç ä¹‹åï¼Œæˆå‘˜å˜é‡å¹¶æ²¡æœ‰é‡æ’ï¼Œè€Œæ˜¯ä¿æŒäº†åœ¨ OC ç±»ä¸­å®šä¹‰çš„é¡ºåºï¼Œè€Œå±æ€§ä¾ç„¶ä¼šæŒ‰ç…§å†…å­˜å ç”¨æœ€ä¼˜è§£è¿›è¡Œé‡æ’
```

ç”±äº OC ä¸­æ‰€æœ‰çš„ç±»éƒ½æ˜¯ç»§æ‰¿è‡ª NSObjectï¼Œæ‰€ä»¥åœ¨ OC ç±»è½¬ä¸ºç»“æ„ä½“ä¹‹åï¼Œç¬¬ä¸€ä¸ªæˆå‘˜éƒ½ä¸º isa æŒ‡é’ˆï¼Œå  8 ä¸ªå­—èŠ‚ï¼Œæ¥ä¸‹æ¥æ˜¯ç±»çš„æˆå‘˜å˜é‡ï¼ˆæŒ‰å®šä¹‰é¡ºåºå­˜å‚¨ï¼‰ï¼Œæœ€åæ˜¯é‡æ’åçš„å±æ€§ï¼›

NSObject ç±»çš„å®ä¾‹å¯¹è±¡æˆå‘˜å˜é‡çš„å¤§å°ä¸º 8, åœ¨ NSObject_IMPL ä¸­ä¹Ÿå°±æ˜¯ isa æ‰€å ç”¨çš„å­—èŠ‚ï¼ŒNSObjectåœ¨å†…å­˜ä¸­å®é™…å ç”¨çš„å¤§å°ä¹Ÿä¸º8ï¼Œä½†æ˜¯ç”±äºç³»ç»Ÿåˆ†é…å†…å­˜å¯¹å…¶åŸåˆ™ï¼Œå®é™…ä¸º NSObject å®ä¾‹å¯¹è±¡åˆ†é…çš„å†…å­˜åˆ™ä¸º 16

é€šè¿‡ `class_getInstanceSize([NSObject class])` ä¼ å…¥ç±»å¯¹è±¡ï¼Œå¯ä»¥è·å–åˆ°ç±»å®é™…å ç”¨çš„å†…å­˜
è€Œé€šè¿‡ `malloc_size` ä¼ å…¥å®ä¾‹å¯¹è±¡ï¼Œè¿”å›çš„ä¸ºç³»ç»Ÿä¸ºè¯¥å®ä¾‹å¯¹è±¡å®é™…åˆ†é…çš„å†…å­˜

```Objective-C
#import <Foundation/Foundation.h>
#import <objc/runtime.h>
#import <malloc/malloc.h>

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        NSObject *obj = [[NSObject alloc] init];
        // è·å– NSObject ç±»çš„å®ä¾‹å¯¹è±¡æˆå‘˜å˜é‡çš„å¤§å° >> 8, åœ¨ NSObject_IMPL ä¸­ä¹Ÿå°±æ˜¯ isa æ‰€å ç”¨çš„å­—èŠ‚
        NSLog(@"%zd", class_getInstanceSize([NSObject class]));
//        class_getInstanceSize å®ç°
//        size_t class_getInstanceSize(Class cls)
//        {
//            if (!cls) return 0;
//            return cls->alignedInstanceSize();
//        }
//        Class's ivar size rounded up to a pointer-size boundary.
//        uint32_t alignedInstanceSize() const {
//            return word_align(unalignedInstanceSize());
//        }
        
        
        // è·å– obj æŒ‡é’ˆæŒ‡å‘å†…å­˜çš„å¤§å° >> 16 ï¼ˆ8ä¸ªå­—èŠ‚å­˜isaæŒ‡é’ˆï¼Œå¦å¤–8ä¸ªç©ºï¼‰
        // malloc_size è·å–åˆ†é…å†…å­˜çš„å¤§å°
        NSLog(@"%zd", malloc_size((__bridge const void *)(obj)));
    }
    return 0;
}

```

![image](assets/Object/oc-obj-address.min.jpg)

ä¹Ÿå¯ä»¥é€šè¿‡debugæ¥é€šè¿‡æ–­ç‚¹æ¥æŸ¥çœ‹objçš„å†…å­˜åˆ†é…ä¾§é¢æ¥è¯æ˜objçš„å†…å­˜å ç”¨æƒ…å†µ

Debug-> Debug Workflow -> view memoryï¼Œé€šè¿‡è¾“å…¥objçš„å†…å­˜åœ°å€æ¥æŸ¥çœ‹è¿ç»­16ä¸ªå­—èŠ‚çš„å†…å­˜å ç”¨æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°å‰8ä½æ˜¯æœ‰å€¼çš„ï¼Œå8ä½ä¸º0

![image](assets/Object/debug-memory.min.jpg)


### Student çš„æœ¬è´¨

![image](assets/Object/student-impl.min.jpg)


```Objective-C
@interface Student : NSObject{
    @public
    int _no;
    int _age;
}
@end

@implementation Student

@end

// Student Implementation
struct Student_IMPL {
    struct NSObject_IMPL NSObject_IVARS;
    int _no;
    int _age;
};

```

