<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <title>
        
        iOS持续集成-Jenkins
        
    </title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.css"/>
    <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/swift.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/ruby.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/bash.min.js"></script>
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <link rel="stylesheet" href="/css/index.css">
    <script src="/js/md5.js"></script>

    <link href="//at.alicdn.com/t/font_751236_90n6bpjkuko.css" rel="stylesheet" type="text/css">
    <script type="text/javascript">
        $(document).ready(function() {
            $('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="container">
            <div class="navbar navbar-expand-sm navbar-light">
    <a class="navbar-brand" href="#">
        <img src="/img/ava.jpg" width="30" height="30" alt="">
    </a>
    <button class="navbar-toggler btn-sm border-0" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a href="/" class=" nav-link ">
                    Home
                </a>
            </li>
            <li class="nav-item">
                <a href="/archives" class=" nav-link ">
                    Archives
                </a>
            </li>
            <li class="nav-item">
                <a href="/about/" class=" nav-link ">
                    about
                </a>
            </li>
        </ul>
    </div>
</div>
        </div>
        <hr />
        <div class="container">
            <div class="container">
    <div>
        <h5>
            iOS持续集成-Jenkins
        </h5>
    </div>
    <div class="postHeaderFontTime">
        <span>2017-12-01 17:20:00</span>
        <span>&nbsp&nbsp&nbsp</span>
        
        <span><span class="iconfont icon-tags"></span>
            
            <a class="text-secondary" href="/tags/iOS/" title="iOS">iOS</a>
            
            <a class="text-secondary" href="/tags/Jenkins/" title="Jenkins">Jenkins</a>
            
            
        </span>

        <span>&nbsp&nbsp&nbsp</span>
        <span class="iconfont icon-read"></span> <span class="text-secondary" id="busuanzi_value_page_pv"></span>
    </div>
    <hr />
    <div class="post-content ">
        <div class="markdown-body">
            <p>最近真的是各种奇葩需求各种提，单位恨不得每个产品都要单独搞一个App来支持，So每次打包提测都是超级痛苦，一次n多个包每个包又有两三个环境，每次搞得头都大了，于是研究了下持续集成，Jenkins这个最近很火的持续集成和持续交付工具当然是首选了。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>对于安装我就不多说了，网上一搜一大堆，官方教程也很详细，直接去看就好了<a href="https://jenkins.io/doc/pipeline/tour/getting-started/" target="_blank" rel="noopener">Jenkins安装</a></p>
<h3 id="新建工程"><a href="#新建工程" class="headerlink" title="新建工程"></a>新建工程</h3><p>这个其实很多文章也都写的很详细了，登录后选择“新建”， 输入项目名称，选择“构建一个自由风格的软件项目”， 点击ok就好了<br><img src="http://upload-images.jianshu.io/upload_images/1648999-e005c2bea06f0d50.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新建项目.png"></p>
<p>新建完之后界面大概就是这样的</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1648999-03f83096535b72ac.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="建好的空项目.png"></p>
<h3 id="General"><a href="#General" class="headerlink" title="General"></a>General</h3><p>这里可以设置一些项目基本信息，构建后的项目保存的时间等等，这里就不过多介绍了，不是必填项，怎么感觉到现在为止还啥都写，一路略过来😂。。</p>
<h3 id="源码管理"><a href="#源码管理" class="headerlink" title="源码管理"></a>源码管理</h3><p>这里可以设置None， Git， Svn</p>
<p>None就不说了，没有源码管理，不必从网上check<br>Git：<br>输入Url， Credentials， Branches就好了<br><img src="http://upload-images.jianshu.io/upload_images/1648999-2d1df0ff8dca3fc7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="git.png"></p>
<p>SVN：<br>跟git差不多<br><img src="http://upload-images.jianshu.io/upload_images/1648999-57fbfd22542ef410.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="svn.png"></p>
<h3 id="构建触发"><a href="#构建触发" class="headerlink" title="构建触发"></a>构建触发</h3><p>这里可以通过一些方法自动触发构建操作，而不需要通过登录到jenkins手动触发构建，同样不多介绍</p>
<h3 id="构建环境"><a href="#构建环境" class="headerlink" title="构建环境"></a>构建环境</h3><p>由于我在后边构建中使用的是shell，没有使用jenkins提供的插件，所以这一步没过多研究<br>不过我发现在这里有些blog上使用插件构建的时候在选择“Keychains and Code Signing Identities”以及“Mobile Provisioning Profiles”这两个地方的描述有些不负责任。<br>在升级到Sierra之后是无法获取到<code>login.keychain</code>的，<code>/Users/murphlu/Library/Keychains</code>目录下找到的只有<code>.keychain-db</code>文件，这个文件jenkins的插件是识别不到的(我找了好多人写的所谓的解决方法，并没有成功解决这个问题，如果有谁有亲测可行的方法也希望能指正)，这也是为啥我选择了使用xcodebuild在shell中直接写，而不是用jenkins的插件“Xcode integration”去实现自动打包。<br>使用xcodebuild通过shell实现自动打包也是有好处的，可控性要高一些，我们可以知道我们每一步都在做什么。这一步同样略过。</p>
<h3 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h3><p>敲黑板， 重点来了~~</p>
<p>首先，如果是pod项目，可以通过添加 Update CocoaPods 确保在打包之前我们的 pod 是正常状态，当然如果每次都执行pod update过慢的话可以略过这一步，直接看下面</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1648999-1dd77dc0634df70f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="pod.png"></p>
<p>构建中我们选择“增加构建步骤” &gt; “Execute shell”<br><img src="http://upload-images.jianshu.io/upload_images/1648999-fe678e7332229384.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新增构建步骤.png"></p>
<p>在这里你可以自由发挥，终端的命令都可以用在这里，如果需要哪些东西可以现在终端测试通过了再直接粘过来。</p>
<p>如果没有使用Update CocoaPods这个步骤，那么我们可以通过使用shell来执行pod命令<br><code>pod install --verbose --no-repo-update</code></p>
<p>pod完成之后我们来开始我们的打包步骤：<br>最主要的就是<code>xcodebuild archive</code>, <code>xcodebuild -exportArchive</code>这两个命令</p>
<pre><code class="Ruby"># scheme变量, 后边用的地方比较多，使用变量比较方便
SCHEME=testScheme
#获取系统时间，每次打包后放在打包时间的文件夹下，这样比较好区分
DATE=`date &#39;+%Y-%m-%d_%H:%M:%S&#39;`

#一下一段是为了取得版本号，用来重命名ipa包
#将Build号从Info.plist文件中取出来，导出到version这个文件中
plutil -extract CFBundleVersion binary1 $SCHEME/Info.plist -o version
#从version文件中取出刚才导出的Build号，我的Build是1.0.0.0这种格式的，这里读出后的是&quot;1.0.0.0&quot;这个样子的，是带引号的
VERSION=$(plutil -p version)
#处理Build号到需要的格式，去掉.及引号
VERSION_NUM=`echo ${VERSION//./}`
#最终获得1000这种格式
VERSION_NUM=`echo ${VERSION_NUM//\&quot;/}`

# 将工程打包成.xcarchive的文件，这里需要指定一些参数
# -workspace 由于我这里是pod项目，所以需要使用-workspace这个参数，如果不是需要替换为-project这个参数，后边带上参数名
# -scheme 需要打包的scheme的名字，可以使用xcodebuild -list在项目根目录下查看
# ENABLE_BITCODE 是否使用bitcode打包
# CODE_SINE_IDENTITY 这个是证书的identity，后边告诉大家如何查看
# PROVISIONING_PROFILE 打包使用的描述文件UUID，描述文件的名称貌似也可以，不过我没有试验，如果可以请指正，至于描述文件UUID的查看方法后边有写
# -archivePath 导出.xcarchive 文件的路径
# -configuration 打包环境 release或是debug
# -destination 这个copy来的，应该就是平台之类的吧
xcodebuild archive -workspace $SCHEME.xcworkspace \
-scheme $SCHEME \
-sdk &quot;iphoneos&quot; \
ENABLE_BITCODE=&quot;NO&quot; \
CODE_SINE_IDENTITY=&quot;iPhone Distribution:.....&quot; \
PROVISIONING_PROFILE=&quot;50c90b02-0545-494b-87ff-4c00e8b4415a&quot; \
-archivePath ./$scheme.xcarchive \
-configuration Debug \
-destination generic/platform=iOS

# 导出xcarchive文件到ipa文件
# -archivePath上一步导出的xcarchive路径
# -exportPath 导出.ipa到哪里
# -exportOptionsPlist 这个xcode9之后是必须的，所以后边写了一下archiveOpt.plist包含的内容，这个可以直接在工程里添加，上传到版本管理工具然后check代码的时候直接down下来，然后从工程项目读取就行了，或者通过plutil自动生成
xcodebuild -exportArchive -archivePath $SCHEME&#39;.xcarchive&#39; \
-exportPath &#39;./&#39;$SCHEME&#39;/&#39;$DATE&#39;/&#39; \
-exportOptionsPlist &#39;exportOptionsPlist.plist&#39;

# 这里其实就是重命名了一下ipa，加了个版本号在名字后边，方便管理
mv &#39;./&#39;$SCHEME&#39;/&#39;$DATE&#39;/&#39;$SCHEME&#39;.ipa&#39; &#39;./&#39;$scheme&#39;/&#39;$DATE&#39;/&#39;$SCHEME&#39;&#39;$VERSION_NUM.ipa
</code></pre>
<p>最终整个shell看起来是这样的<br><img src="http://upload-images.jianshu.io/upload_images/1648999-8c6af49a7742c409.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="shell.png"></p>
<p>读取证书的identity，直接拷出来就好了</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1648999-7843ae7d9814b058.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>描述文件：<br>可以通过jenkins插件查看 “Keychains and Provisioning Profiles Management”这个插件<br>在系统管理中找到这个插件<br><img src="http://upload-images.jianshu.io/upload_images/1648999-116bf0e210a79d4e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1648999-4626bcdc7a16a010.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>exportOptionsPlist</p>
<p>需要包含的内容<br>teamID<br>string类型<br>证书显示简介中的组织单位</p>
<p>method<br>string类型可选值 app-store, ad-hoc, package, enterprise, development, developer-id, mac-application</p>
<p>provisioningProfiles<br>dict类型<br>key-要打包app的bundle ID<br>value-要使用的描述文件的UUID或者名称<br>可以添加多组值，用于多个项目打包</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1648999-0226e268b5ee2cbf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>整个配置好之后我们就可以实现自动打包了，需要打包的时候我们可以分环境给项目设置多个target，然后就可以一次性打出好多包来，我们做的只是点一下等着打包结束就好了<br>当然后边也可以集成蒲公英，fir等测试分发平台，这个好多教程也就不多赘述了。<br>在不断完善过程中你会发现你的生活这的是越来越方便~~~</p>
<p>我同样试了一下使用循环通过定义scheme数组的方式打包，不过没有成功，不知道为啥打包是成功的但是循环没有执行完，我一次性打包两个scheme最终运行正确却只出来一个，无奈只能copy一份代码来执行，不知道有没有大神了解这是怎么回事</p>
<p>标题有点唬人了，只是提了个自动打包，就美其名曰持续集成了，其实持续集成是一个不断完善的过程，主要还是软件开发到部署整个流程上的控制以及完善，让开发整个流程中的个人只需关注自己真正要做的事情，其他的都交给系统去处理，实现开发测试部署各阶段中间流程的自动化</p>
<p>ok, 就是这样了，哪里有表述不清楚或者有问题的希望大神们指正，毕竟是刚刚开始研究，有很多模糊的地方</p>

        </div>
        <hr />
        <div class="col-12">
            <div style="text-align: center">
            <div class="btn-group" role="group" aria-label="Basic example">
                
                <a class="btn btn-outline-info" href="/2018/01/17/UILabel之Inset/">上一篇</a>
                
                
                <a class="btn btn-outline-info" href="/2017/11/22/WKWebView下js的alert(),confirm(),prompt()方法无法正常执行/">下一篇</a>
                
            </div>
            </div>

        </div>
        <div id="comment-container">
        </div>
    </div>
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            id: md5('iOS持续集成-Jenkins'), // 可选。默认为 location.href
            owner: 'MurphLu',
            repo: 'murphlu.github.io',
            oauth: {
                client_id: '01c3bc760286123e1272',
                client_secret: '5c33b24d431b6a6193d31eff81f2d0ed3c15bdcb',
            },
        })
        gitment.render('comment-container')
    </script>
</div>
        </div>
        <div class="container">
            <div class="container">
    <hr />
    <p class="text-center">
        
        <a class="text-dark" target="_blank" href="https://github.com/MurphLu">
            <i class="iconfont icon-github"></i>
        </a>
        
        
        <a class="text-dark" target="_blank" href="https://www.zhihu.com/people/jy-lu-59">
            <i class="iconfont icon-zhihu"></i>
        </a>
        
        
        <a class="text-dark" target="_blank" href="https://weibo.com/HiGodl">
            <i class="iconfont icon-sina"></i>
        </a>
        

        
        <a class="text-dark" target="_blank" href="https://www.facebook.com/lijiyang.jyLu">
            <i class="iconfont icon-facebook"></i>
        </a>
        

        
        <a class="text-dark" target="_blank" href="https://mobile.twitter.com/jy_LuS">
            <i class="iconfont icon-twitter"></i>
        </a>
        

        
        <a class="text-dark" target="_blank" href="https://www.instagram.com/jiy_lulu">
            <i class="iconfont icon-instagram"></i>
        </a>
        

        
        <a class="text-dark" target="_blank" href="https://www.linkedin.com/in/继扬-陆-869a17124">
            <i class="iconfont icon-linkedin"></i>
        </a>
        

        <!---->

        

        

    </p>
    <p class="text-center text-muted footerFont">

        © 2018 - 2019 Murph Lu | Powered by <a class="text-info" href="https://hexo.io">Hexo</a> |
        <span id="busuanzi_container_site_uv">
            visitor <span id="busuanzi_value_site_uv"></span>
        </span>
    </p>
</div>
        </div>
    </div>
</body>

</html>